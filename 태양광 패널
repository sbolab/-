import datetime
import pymysql
import time
from epevermodbus.driver import EpeverChargeController

port_name = '/dev/ttyACM1'
slave_address = 1

controller = EpeverChargeController(portname=port_name, slaveaddress=slave_address, baudrate=115200)

connection_config = {
    'host': '',
    'user': '',
    'password': '',
    'database': ''
}


def read_and_process_data():
    try:
        generated_energy_today = controller.get_generated_energy_today()
        battery_soc = controller.get_battery_state_of_charge()
        consumed_energy_today = controller.get_consumed_energy_today()
        current_time = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")

        insert_query = "INSERT INTO solarpanel (generated_energy_today, battery_soc, consumed_energy_today, Solar_Radiation_Time, Panel_ID) VALUES (%s, %s, %s, %s, %s)"
        data = (generated_energy_today, battery_soc, consumed_energy_today, current_time, 'default')

        connection = pymysql.connect(**connection_config)
        cursor = connection.cursor()
        cursor.execute(insert_query, data)
        connection.commit()

        print(
            f"generated_energy_today: {generated_energy_today:.2f} kWh, Battery SOC: {battery_soc}%, consumed_energy_today: {consumed_energy_today:.2f} kWh")

    except Exception as e:
        print(f"Error processing data: {e}")


try:
    while True:
        read_and_process_data()

        time.sleep(5)
except KeyboardInterrupt:
    print("Data reading stopped.")
    connection.close()
